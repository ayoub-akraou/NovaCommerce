generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Cart {
  id        String     @id @default(cuid())
  userId    String?
  status    CartStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user  User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  items CartItem[]

  @@index([userId, status])
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  unitPrice Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([cartId, productId])
  @@index([productId])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]
}

model Product {
  id             String   @id @default(cuid())
  categoryId     String
  title          String
  slug           String   @unique
  description    String?
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  stock          Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  category   Category       @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  images     ProductImage[]
  tags       ProductTag[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([categoryId])
  @@index([slug, isActive])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  position  Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, position])
  @@index([productId])
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())

  products ProductTag[]
}

model ProductTag {
  productId String
  tagId     String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@index([tagId])
}

enum UserRole {
  CUSTOMER
  MANAGER
  ADMIN
}

enum CartStatus {
  ACTIVE
  CONVERTED
  ABANDONED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  MOCK
  STRIPE
}

model Order {
  id                String      @id @default(cuid())
  orderNumber       Int         @unique @default(autoincrement())
  userId            String
  status            OrderStatus @default(PENDING)
  subtotal          Decimal     @db.Decimal(10, 2)
  shippingFee       Decimal     @default(0) @db.Decimal(10, 2)
  discountTotal     Decimal     @default(0) @db.Decimal(10, 2)
  taxTotal          Decimal     @default(0) @db.Decimal(10, 2)
  total             Decimal     @db.Decimal(10, 2)
  currency          String      @default("EUR")
  shippingAddressId String?
  billingAddressId  String?
  notes             String?
  paidAt            DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  shippingAddress Address?    @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id], onDelete: SetNull)
  billingAddress  Address?    @relation("OrderBillingAddress", fields: [billingAddressId], references: [id], onDelete: SetNull)
  items           OrderItem[]
  payments        Payment[]

  @@index([userId, status])
  @@index([createdAt])
}

model OrderItem {
  orderId         String
  productId       String
  quantity        Int
  unitPrice       Decimal  @db.Decimal(10, 2)
  priceAtPurchase Decimal  @db.Decimal(10, 2)
  titleSnapshot   String
  slugSnapshot    String
  createdAt       DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@id([orderId, productId])
  @@index([productId])
}

model Payment {
  id          String          @id @default(cuid())
  orderId     String
  provider    PaymentProvider @default(MOCK)
  status      PaymentStatus   @default(PENDING)
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("EUR")
  providerRef String?         @unique
  paidAt      DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, status])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  firstName    String?
  lastName     String?
  passwordHash String
  role         UserRole @default(CUSTOMER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  addresses Address[]
  carts     Cart[]
  orders    Order[]
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  label      String?
  fullName   String
  phone      String?
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String
  country    String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders Order[] @relation("OrderShippingAddress")
  billingOrders  Order[] @relation("OrderBillingAddress")

  @@index([userId])
}
